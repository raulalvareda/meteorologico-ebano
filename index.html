<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reporte Meteorologico | Ebano ‚Äî DIAVAZ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root {
    --bg-dark: #0a1628; --bg-card: #0e1f3d; --bg-card2: #112244;
    --accent: #1e6fe8; --accent2: #00c8ff; --accent3: #00e5b0;
    --text: #e8f0fe; --text-muted: #7a9ec4; --border: #1a3060;
    --good: #00e5b0; --moderate: #f7c94b; --rough: #f07c3a; --storm: #e83030;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--bg-dark); color:var(--text); min-height:100vh; }
  .header {
    background:linear-gradient(135deg,#0d1b3e 0%,#112244 50%,#0a1628 100%);
    border-bottom:2px solid #1a3a6b; padding:14px 32px;
    display:flex; align-items:center; justify-content:space-between;
    position:sticky; top:0; z-index:100; box-shadow:0 4px 24px rgba(0,0,0,0.5);
  }
  .header-left { display:flex; align-items:center; gap:18px; }
  .header-divider { width:1px; height:44px; background:var(--border); flex-shrink:0; }
  .header-title-block h1 { font-size:1.2rem; font-weight:800; color:var(--text); line-height:1.2; }
  .header-title-block h1 span { color:var(--accent2); }
  .header-title-block p { font-size:0.74rem; color:var(--text-muted); margin-top:3px; }
  .header-right { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .data-source-badge {
    background:rgba(0,200,255,0.1); border:1px solid rgba(0,200,255,0.3);
    border-radius:8px; padding:6px 12px; font-size:0.72rem; color:var(--accent2);
    display:flex; align-items:center; gap:6px;
  }
  .btn {
    padding:9px 18px; border:none; border-radius:8px;
    font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s;
    display:flex; align-items:center; gap:7px;
  }
  .btn-primary { background:linear-gradient(135deg,var(--accent),#1a5ccc); color:#fff; }
  .btn-primary:hover { transform:translateY(-1px); box-shadow:0 4px 16px rgba(30,111,232,0.4); }
  .btn-secondary { background:var(--bg-card2); color:var(--text); border:1px solid var(--border); }
  .btn-secondary:hover { border-color:var(--accent2); }
  .btn-success { background:linear-gradient(135deg,#00b894,#00a381); color:#fff; }
  .btn-success:hover { transform:translateY(-1px); box-shadow:0 4px 16px rgba(0,200,176,0.3); }
  .container { max-width:1400px; margin:0 auto; padding:28px 24px; }
  .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:16px; margin-bottom:28px; }
  .kpi-card {
    background:var(--bg-card); border:1px solid var(--border); border-radius:14px;
    padding:20px 18px; position:relative; overflow:hidden; transition:transform 0.2s;
  }
  .kpi-card:hover { transform:translateY(-2px); }
  .kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--accent-color,var(--accent)); }
  .kpi-icon { font-size:26px; margin-bottom:10px; }
  .kpi-label { font-size:0.72rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.8px; }
  .kpi-value { font-size:2rem; font-weight:800; line-height:1.1; margin:6px 0 4px; }
  .kpi-sub { font-size:0.75rem; color:var(--text-muted); }
  .section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  .section-title { font-size:1rem; font-weight:700; display:flex; align-items:center; gap:8px; }
  .section-title span { color:var(--accent2); }
  .charts-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(560px,1fr)); gap:20px; margin-bottom:28px; }
  .chart-card { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:22px; }
  .chart-card.full-width { grid-column:1/-1; }
  .chart-title { font-size:0.88rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.7px; margin-bottom:18px; display:flex; align-items:center; gap:8px; }
  .chart-wrapper { position:relative; height:220px; }
  .chart-wrapper-tall { position:relative; height:280px; }
  .table-card { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-bottom:28px; }
  .table-scroll { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; font-size:0.82rem; }
  thead th { background:#0d1a35; padding:12px 14px; text-align:center; color:var(--text-muted); font-size:0.72rem; text-transform:uppercase; letter-spacing:0.7px; border-bottom:1px solid var(--border); white-space:nowrap; }
  tbody tr { border-bottom:1px solid rgba(26,48,96,0.5); transition:background 0.15s; }
  tbody tr:hover { background:rgba(30,111,232,0.08); }
  tbody td { padding:11px 14px; text-align:center; white-space:nowrap; }
  .td-hora { color:var(--accent2); font-weight:700; }
  .td-estado { padding:3px 10px; border-radius:20px; font-size:0.7rem; font-weight:700; display:inline-block; }
  .estado-bonanza { background:rgba(0,229,176,0.15); color:var(--good); }
  .estado-moderado { background:rgba(247,201,75,0.15); color:var(--moderate); }
  .estado-agitado { background:rgba(240,124,58,0.15); color:var(--rough); }
  .estado-bravo { background:rgba(232,48,48,0.15); color:var(--storm); }
  .forecast-bar { display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-bottom:28px; }
  .fbar-card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:14px 12px; text-align:center; cursor:pointer; transition:all 0.2s; }
  .fbar-card:hover,.fbar-card.active { border-color:var(--accent2); background:var(--bg-card2); }
  .fbar-day { font-size:0.72rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; }
  .fbar-date { font-size:0.78rem; font-weight:700; margin:4px 0; }
  .fbar-icon { font-size:1.6rem; margin:6px 0; }
  .fbar-wind { font-size:0.82rem; font-weight:700; color:var(--accent2); }
  .fbar-wave { font-size:0.72rem; color:var(--text-muted); }
  .fbar-estado { font-size:0.68rem; font-weight:700; margin-top:4px; }
  .legend { display:flex; gap:16px; flex-wrap:wrap; align-items:center; font-size:0.75rem; color:var(--text-muted); }
  .legend-item { display:flex; align-items:center; gap:6px; }
  .legend-dot { width:10px; height:10px; border-radius:50%; }
  .unit { font-size:0.65rem; color:var(--text-muted); vertical-align:super; }
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:999; align-items:center; justify-content:center; }
  .modal-overlay.active { display:flex; }
  .modal { background:var(--bg-card); border:1px solid var(--border); border-radius:18px; padding:30px; width:400px; max-width:94vw; }
  .modal h3 { font-size:1.1rem; margin-bottom:20px; }
  .modal-option { background:var(--bg-dark); border:1px solid var(--border); border-radius:10px; padding:14px 16px; margin-bottom:10px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:12px; }
  .modal-option:hover { border-color:var(--accent); }
  .modal-option input[type="checkbox"] { accent-color:var(--accent); width:17px; height:17px; }
  .modal-option label { cursor:pointer; }
  .modal-option .opt-title { font-weight:600; font-size:0.9rem; }
  .modal-option .opt-sub { font-size:0.76rem; color:var(--text-muted); margin-top:2px; }
  .modal-btns { display:flex; gap:10px; margin-top:18px; justify-content:flex-end; }
  .loader-overlay { display:none; position:fixed; inset:0; background:rgba(10,22,40,0.85); z-index:1000; align-items:center; justify-content:center; flex-direction:column; gap:16px; }
  .loader-overlay.active { display:flex; }
  .spinner { width:48px; height:48px; border:4px solid rgba(30,111,232,0.2); border-top-color:var(--accent2); border-radius:50%; animation:spin 0.9s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  @media (max-width:700px) {
    .charts-grid { grid-template-columns:1fr; }
    .forecast-bar { grid-template-columns:repeat(2,1fr); }
    .header { flex-direction:column; gap:12px; }
    .header-right { justify-content:center; }
  }
</style>
</head>
<body>

<div class="header" id="main-header">
  <div class="header-left">
    <div class="header-title-block">
      <h1>Reporte Meteorologico <span>| Ebano</span></h1>
      <p>üìç 19.146¬∞N 92.500¬∞W ¬∑ Pr√≥ximos 5 d√≠as ¬∑ <span id="update-time">2026-02-25 19:56 CST</span></p>
    </div>
  </div>
  <div class="header-right">
    <div class="data-source-badge">üõ∞Ô∏è ECMWF WAM</div>
    <button class="btn btn-secondary" onclick="toggleDayView()">üìÖ Vista por D√≠a</button>
    <button class="btn btn-primary" onclick="openPdfModal()">üìÑ Exportar PDF</button>
  </div>
</div>

<div class="container">
  <div class="forecast-bar" id="forecast-bar"></div>
  <div class="kpi-grid" id="kpi-grid"></div>

  <div id="section-charts">
    <div class="section-header">
      <div class="section-title">üìä <span>Gr√°ficas</span> ‚Äî Pron√≥stico 5 d√≠as</div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#00c8ff"></div>Viento</div>
        <div class="legend-item"><div class="legend-dot" style="background:#f7c94b"></div>R√°fagas</div>
        <div class="legend-item"><div class="legend-dot" style="background:#00e5b0"></div>Olas</div>
        <div class="legend-item"><div class="legend-dot" style="background:#c084fc"></div>Swell</div>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card" id="card-wind">
        <div class="chart-title">üí® Velocidad del Viento & R√°fagas (kt)</div>
        <div class="chart-wrapper"><canvas id="chartWind"></canvas></div>
      </div>
      <div class="chart-card" id="card-wave">
        <div class="chart-title">üåä Altura de Olas & Swell (ft)</div>
        <div class="chart-wrapper"><canvas id="chartWave"></canvas></div>
      </div>
      <div class="chart-card" id="card-dir">
        <div class="chart-title">üß≠ Direcci√≥n del Viento (¬∞)</div>
        <div class="chart-wrapper"><canvas id="chartDir"></canvas></div>
      </div>
      <div class="chart-card" id="card-hocnl">
        <div class="chart-title">üìà HOCNL ‚Äî Altura Ola Caracter√≠stica (ft)</div>
        <div class="chart-wrapper"><canvas id="chartHocnl"></canvas></div>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card full-width" id="card-combined">
        <div class="chart-title">üìâ Resumen Combinado ‚Äî 5 d√≠as (cada 3h)</div>
        <div class="chart-wrapper-tall"><canvas id="chartCombined"></canvas></div>
      </div>
    </div>
  </div>

  <div id="section-table">
    <div class="section-header">
      <div class="section-title">üìã <span>Tabla General</span> ‚Äî Pron√≥stico por Hora</div>
      <select id="day-filter" onchange="filterTable()" style="background:var(--bg-card2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:7px 12px;font-size:0.82rem;cursor:pointer;">
        <option value="all">Todos los d√≠as</option>
      </select>
    </div>
    <div class="table-card">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>üìÖ Fecha</th><th>üïê Hora</th><th>üí® Viento (kt)</th>
              <th>‚ö° R√°faga (kt)</th><th>üß≠ Direcci√≥n</th><th>üåä Olas (ft)</th>
              <th>üåÄ Swell (ft)</th><th>üìä HOCNL (ft)</th><th>üè∑Ô∏è Estado</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- PDF MODAL -->
<div class="modal-overlay" id="pdf-modal">
  <div class="modal">
    <h3>üìÑ Exportar a PDF</h3>
    <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:16px;">Selecciona qu√© secciones incluir:</p>
    <label class="modal-option" for="chk-header">
      <input type="checkbox" id="chk-header" checked>
      <div><div class="opt-title">üåä Encabezado + KPIs</div><div class="opt-sub">Resumen del pron√≥stico</div></div>
    </label>
    <label class="modal-option" for="chk-charts">
      <input type="checkbox" id="chk-charts" checked>
      <div><div class="opt-title">üìä Gr√°ficas</div><div class="opt-sub">Viento, olas y swell</div></div>
    </label>
    <label class="modal-option" for="chk-table">
      <input type="checkbox" id="chk-table" checked>
      <div><div class="opt-title">üìã Tabla General</div><div class="opt-sub">Datos horarios completos</div></div>
    </label>
    <div class="modal-btns">
      <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-success" onclick="exportPDF()">‚¨áÔ∏è Generar PDF</button>
    </div>
  </div>
</div>

<div class="loader-overlay" id="loader">
  <div class="spinner"></div>
  <div style="color:var(--text-muted);font-size:0.85rem;">Generando PDF...</div>
</div>

<script>
// ‚îÄ‚îÄ DATOS REALES ECMWF WAM ‚Äî extra√≠dos de Pronostico_Windy_19N_92W.xlsx ‚îÄ‚îÄ
// Fuente: Posici√≥n: 19.146¬∞N / 92.500¬∞O  |  Modelo: ECMWF WAM  |  Generado: 2026-02-25 19:56 CST  |  Ref. Hora: 2026-02-25 06Z  |  Actualizado: Hace 5h
const SOURCE_DATA = [{"fecha": "2026-02-25", "hora": "03:00", "viento": 12, "dir": 75, "racha": 17, "olas": 4, "oleaje1": 3, "periodo": 7, "cardinal": "ENE", "hocnl": 4.9}, {"fecha": "2026-02-25", "hora": "06:00", "viento": 11, "dir": 106, "racha": 17, "olas": 4, "oleaje1": 3, "periodo": 6.5, "cardinal": "ESE", "hocnl": 5.1}, {"fecha": "2026-02-25", "hora": "09:00", "viento": 14, "dir": 120, "racha": 19, "olas": 4, "oleaje1": 3, "periodo": 6.3, "cardinal": "ESE", "hocnl": 5.0}, {"fecha": "2026-02-25", "hora": "12:00", "viento": 15, "dir": 108, "racha": 21, "olas": 4, "oleaje1": 3, "periodo": 6.4, "cardinal": "ESE", "hocnl": 5.2}, {"fecha": "2026-02-25", "hora": "15:00", "viento": 16, "dir": 94, "racha": 24, "olas": 4, "oleaje1": 2, "periodo": 6.5, "cardinal": "E", "hocnl": 5.6}, {"fecha": "2026-02-25", "hora": "18:00", "viento": 15, "dir": 55, "racha": 21, "olas": 3, "oleaje1": 2, "periodo": 6.8, "cardinal": "NE", "hocnl": 3.9}, {"fecha": "2026-02-25", "hora": "21:00", "viento": 12, "dir": 67, "racha": 20, "olas": 3, "oleaje1": 2, "periodo": 6.5, "cardinal": "ENE", "hocnl": 4.1}, {"fecha": "2026-02-26", "hora": "00:00", "viento": 10, "dir": 93, "racha": 16, "olas": 2, "oleaje1": 2, "periodo": 6.4, "cardinal": "E", "hocnl": 2.6}, {"fecha": "2026-02-26", "hora": "03:00", "viento": 18, "dir": 134, "racha": 24, "olas": 3, "oleaje1": 2, "periodo": 5.3, "cardinal": "SE", "hocnl": 4.0}, {"fecha": "2026-02-26", "hora": "06:00", "viento": 18, "dir": 135, "racha": 24, "olas": 4, "oleaje1": 2, "periodo": 5.4, "cardinal": "SE", "hocnl": 5.3}, {"fecha": "2026-02-26", "hora": "09:00", "viento": 18, "dir": 133, "racha": 25, "olas": 4, "oleaje1": 2, "periodo": 5.8, "cardinal": "SE", "hocnl": 5.5}, {"fecha": "2026-02-26", "hora": "12:00", "viento": 11, "dir": 128, "racha": 24, "olas": 4, "oleaje1": 3, "periodo": 5.8, "cardinal": "SE", "hocnl": 6.4}, {"fecha": "2026-02-26", "hora": "15:00", "viento": 8, "dir": 88, "racha": 15, "olas": 3, "oleaje1": 2, "periodo": 4.2, "cardinal": "E", "hocnl": 4.0}, {"fecha": "2026-02-26", "hora": "18:00", "viento": 10, "dir": 78, "racha": 12, "olas": 2, "oleaje1": 2, "periodo": 4.8, "cardinal": "ENE", "hocnl": 2.2}, {"fecha": "2026-02-26", "hora": "21:00", "viento": 10, "dir": 73, "racha": 13, "olas": 2, "oleaje1": 1, "periodo": 5.8, "cardinal": "ENE", "hocnl": 2.3}, {"fecha": "2026-02-27", "hora": "00:00", "viento": 10, "dir": 99, "racha": 12, "olas": 1, "oleaje1": 1, "periodo": 5.8, "cardinal": "E", "hocnl": 1.1}, {"fecha": "2026-02-27", "hora": "03:00", "viento": 10, "dir": 98, "racha": 18, "olas": 2, "oleaje1": 1, "periodo": 5.7, "cardinal": "E", "hocnl": 2.8}, {"fecha": "2026-02-27", "hora": "06:00", "viento": 15, "dir": 130, "racha": 19, "olas": 2, "oleaje1": 1, "periodo": 5.8, "cardinal": "SE", "hocnl": 2.4}, {"fecha": "2026-02-27", "hora": "09:00", "viento": 12, "dir": 137, "racha": 20, "olas": 2, "oleaje1": 1, "periodo": 5, "cardinal": "SE", "hocnl": 2.8}, {"fecha": "2026-02-27", "hora": "12:00", "viento": 9, "dir": 102, "racha": 16, "olas": 2, "oleaje1": 2, "periodo": 4, "cardinal": "ESE", "hocnl": 2.7}, {"fecha": "2026-02-27", "hora": "15:00", "viento": 8, "dir": 54, "racha": 12, "olas": 2, "oleaje1": 1, "periodo": 3.6, "cardinal": "NE", "hocnl": 2.4}, {"fecha": "2026-02-27", "hora": "18:00", "viento": 10, "dir": 26, "racha": 12, "olas": 2, "oleaje1": 1, "periodo": 3.5, "cardinal": "NNE", "hocnl": 2.2}, {"fecha": "2026-02-27", "hora": "21:00", "viento": 11, "dir": 25, "racha": 14, "olas": 2, "oleaje1": 1, "periodo": 3.2, "cardinal": "NNE", "hocnl": 2.3}, {"fecha": "2026-02-28", "hora": "00:00", "viento": 10, "dir": 40, "racha": 14, "olas": 1, "oleaje1": 1, "periodo": 2.9, "cardinal": "NE", "hocnl": 1.2}, {"fecha": "2026-02-28", "hora": "03:00", "viento": 12, "dir": 55, "racha": 21, "olas": 2, "oleaje1": 0, "periodo": 0, "cardinal": "NE", "hocnl": 2.8}, {"fecha": "2026-02-28", "hora": "06:00", "viento": 11, "dir": 62, "racha": 16, "olas": 2, "oleaje1": 1, "periodo": 3.6, "cardinal": "ENE", "hocnl": 2.5}, {"fecha": "2026-02-28", "hora": "09:00", "viento": 10, "dir": 128, "racha": 14, "olas": 2, "oleaje1": 2, "periodo": 3.7, "cardinal": "SE", "hocnl": 2.4}, {"fecha": "2026-02-28", "hora": "12:00", "viento": 2, "dir": 100, "racha": 13, "olas": 2, "oleaje1": 1, "periodo": 3.5, "cardinal": "E", "hocnl": 3.0}, {"fecha": "2026-02-28", "hora": "15:00", "viento": 7, "dir": 2, "racha": 10, "olas": 2, "oleaje1": 1, "periodo": 3.8, "cardinal": "N", "hocnl": 2.3}, {"fecha": "2026-02-28", "hora": "18:00", "viento": 12, "dir": 7, "racha": 16, "olas": 2, "oleaje1": 1, "periodo": 2.9, "cardinal": "N", "hocnl": 2.4}, {"fecha": "2026-02-28", "hora": "21:00", "viento": 12, "dir": 15, "racha": 16, "olas": 2, "oleaje1": 1, "periodo": 3.1, "cardinal": "NNE", "hocnl": 2.4}, {"fecha": "2026-03-01", "hora": "00:00", "viento": 15, "dir": 31, "racha": 19, "olas": 2, "oleaje1": 0, "periodo": 0, "cardinal": "NNE", "hocnl": 2.4}, {"fecha": "2026-03-01", "hora": "03:00", "viento": 13, "dir": 52, "racha": 19, "olas": 2, "oleaje1": 1, "periodo": 3.7, "cardinal": "NE", "hocnl": 2.6}, {"fecha": "2026-03-01", "hora": "06:00", "viento": 8, "dir": 39, "racha": 16, "olas": 2, "oleaje1": 2, "periodo": 4.1, "cardinal": "NE", "hocnl": 2.8}, {"fecha": "2026-03-01", "hora": "09:00", "viento": 7, "dir": 39, "racha": 10, "olas": 2, "oleaje1": 2, "periodo": 4.1, "cardinal": "NE", "hocnl": 2.3}, {"fecha": "2026-03-01", "hora": "12:00", "viento": 5, "dir": 21, "racha": 10, "olas": 2, "oleaje1": 2, "periodo": 4.1, "cardinal": "NNE", "hocnl": 2.5}, {"fecha": "2026-03-01", "hora": "15:00", "viento": 10, "dir": 1, "racha": 12, "olas": 2, "oleaje1": 2, "periodo": 4.2, "cardinal": "N", "hocnl": 2.2}, {"fecha": "2026-03-01", "hora": "18:00", "viento": 13, "dir": 11, "racha": 17, "olas": 2, "oleaje1": 1, "periodo": 2.7, "cardinal": "N", "hocnl": 2.4}, {"fecha": "2026-03-01", "hora": "21:00", "viento": 14, "dir": 30, "racha": 18, "olas": 2, "oleaje1": 0, "periodo": 0, "cardinal": "NNE", "hocnl": 2.4}, {"fecha": "2026-03-02", "hora": "00:00", "viento": 10, "dir": 42, "racha": 18, "olas": 3, "oleaje1": 2, "periodo": 4, "cardinal": "NE", "hocnl": 4.1}];

const dayNames   = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
const monthNames = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const DIRS = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];

function dirFromDeg(deg) { return DIRS[Math.round(deg/22.5)%16]; }

function statusFromWave(ft) {
  if (ft < 1.6) return {label:'Bonanza', cls:'estado-bonanza', icon:'üü¢'};
  if (ft < 4.1) return {label:'Moderado',cls:'estado-moderado',icon:'üü°'};
  if (ft < 8.2) return {label:'Agitado', cls:'estado-agitado', icon:'üü†'};
  return             {label:'Severo',  cls:'estado-bravo',   icon:'üî¥'};
}

function windIcon(kt) {
  if (kt < 11) return 'üå¨Ô∏è';
  if (kt < 22) return 'üí®';
  if (kt < 33) return 'üåÄ';
  return '‚õàÔ∏è';
}

// Enriquecer datos con info de fecha/d√≠a
const rawData = SOURCE_DATA.map((r, i) => {
  const d = new Date(r.fecha + 'T' + r.hora + ':00');
  return {
    ...r,
    date: d,
    dateStr: `${d.getDate()} ${monthNames[d.getMonth()]}`,
    dayName: dayNames[d.getDay()],
    dirLabel: r.cardinal || dirFromDeg(r.dir),
    wave: r.olas,
    swell: r.oleaje1,
    gust: r.racha,
    wind: r.viento,
    hour: r.hora,
    hocnl: r.hocnl,
    dayIndex: Math.floor(i/8),
    status: statusFromWave(r.olas)
  };
});

const DAYS = 5;

// ‚îÄ‚îÄ FORECAST BAR ‚îÄ‚îÄ
function buildForecastBar() {
  const bar = document.getElementById('forecast-bar');
  bar.innerHTML = '';
  for (let d = 0; d < DAYS; d++) {
    const rows = rawData.filter(r => r.dayIndex === d);
    if (!rows.length) continue;
    const avgWind = (rows.reduce((s,r)=>s+r.wind,0)/rows.length).toFixed(0);
    const maxWave = Math.max(...rows.map(r=>r.wave));
    const st = statusFromWave(maxWave);
    const el = document.createElement('div');
    el.className = 'fbar-card' + (d===0?' active':'');
    el.innerHTML = `
      <div class="fbar-day">${rows[0].dayName}</div>
      <div class="fbar-date">${rows[0].dateStr}</div>
      <div class="fbar-icon">${windIcon(+avgWind)}</div>
      <div class="fbar-wind">${avgWind} kt</div>
      <div class="fbar-wave">Olas: ${maxWave.toFixed(1)} ft</div>
      <div class="fbar-estado" style="color:${
        st.cls.includes('bonanza')?'#00e5b0':
        st.cls.includes('moderado')?'#f7c94b':
        st.cls.includes('agitado')?'#f07c3a':'#e83030'
      }">${st.icon} ${st.label}</div>`;
    el.onclick = () => {
      document.querySelectorAll('.fbar-card').forEach(c=>c.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('day-filter').value = d;
      filterTable();
    };
    bar.appendChild(el);
  }
}
buildForecastBar();

// ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ
function buildKPIs() {
  const avgWind  = (rawData.reduce((s,r)=>s+r.wind,0)/rawData.length).toFixed(1);
  const maxGust  = Math.max(...rawData.map(r=>r.gust)).toFixed(0);
  const maxWave  = Math.max(...rawData.map(r=>r.wave)).toFixed(1);
  const avgSwell = (rawData.reduce((s,r)=>s+r.swell,0)/rawData.length).toFixed(1);
  const maxHocnl = Math.max(...rawData.map(r=>r.hocnl)).toFixed(1);
  const allCards = rawData.map(r=>r.cardinal);
  const dirMode  = allCards.sort((a,b)=>allCards.filter(v=>v===a).length-allCards.filter(v=>v===b).length).pop();
  const kpis = [
    {icon:'üí®',label:'Viento Promedio',value:avgWind, unit:'kt', sub:'Velocidad media',      color:'#1e6fe8'},
    {icon:'‚ö°',label:'R√°faga M√°xima', value:maxGust,  unit:'kt', sub:'Pico de r√°faga',       color:'#f7c94b'},
    {icon:'üåä',label:'Ola M√°xima',    value:maxWave,  unit:'ft', sub:'Altura pico',          color:'#00c8ff'},
    {icon:'üåÄ',label:'Swell Promedio',value:avgSwell, unit:'ft', sub:'Mar de fondo',         color:'#c084fc'},
    {icon:'üìä',label:'HOCNL M√°x.',   value:maxHocnl, unit:'ft', sub:'H. ola caracter√≠stica',color:'#00e5b0'},
    {icon:'üß≠',label:'Dir. Predominante',value:dirMode,unit:'', sub:'Rosa de vientos',       color:'#f97316'},
  ];
  document.getElementById('kpi-grid').innerHTML = kpis.map(k=>`
    <div class="kpi-card" style="--accent-color:${k.color}">
      <div class="kpi-icon">${k.icon}</div>
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}<span class="unit"> ${k.unit}</span></div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');
}
buildKPIs();

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ
const CHART_DEFAULTS = {
  responsive:true, maintainAspectRatio:false,
  plugins:{legend:{labels:{color:'#7a9ec4',font:{size:11}}}},
  scales:{
    x:{ticks:{color:'#7a9ec4',font:{size:10}},grid:{color:'rgba(26,48,96,0.4)'}},
    y:{ticks:{color:'#7a9ec4',font:{size:10}},grid:{color:'rgba(26,48,96,0.4)'}}
  }
};

const shortLabels = rawData.map(r => r.hora === '12:00' ? r.dateStr : r.hora);

new Chart(document.getElementById('chartWind').getContext('2d'), {
  type:'line', data:{
    labels:shortLabels,
    datasets:[
      {label:'Viento (kt)',data:rawData.map(r=>r.wind),borderColor:'#00c8ff',backgroundColor:'rgba(0,200,255,0.1)',tension:0.4,fill:true,pointRadius:2},
      {label:'R√°faga (kt)',data:rawData.map(r=>r.gust),borderColor:'#f7c94b',backgroundColor:'rgba(247,201,75,0.05)',tension:0.4,fill:false,borderDash:[5,3],pointRadius:2}
    ]
  }, options:{...CHART_DEFAULTS}
});

new Chart(document.getElementById('chartWave').getContext('2d'), {
  type:'line', data:{
    labels:shortLabels,
    datasets:[
      {label:'Olas (ft)',data:rawData.map(r=>r.wave),borderColor:'#00e5b0',backgroundColor:'rgba(0,229,176,0.12)',tension:0.4,fill:true,pointRadius:2},
      {label:'Swell (ft)',data:rawData.map(r=>r.swell),borderColor:'#c084fc',backgroundColor:'rgba(192,132,252,0.06)',tension:0.4,fill:false,borderDash:[4,3],pointRadius:2}
    ]
  }, options:{...CHART_DEFAULTS}
});

new Chart(document.getElementById('chartDir').getContext('2d'), {
  type:'bar', data:{
    labels:shortLabels,
    datasets:[{
      label:'Direcci√≥n (¬∞)', data:rawData.map(r=>r.dir),
      backgroundColor:rawData.map(r=>`hsla(${200+r.dir/2},80%,60%,0.6)`),
      borderColor:rawData.map(r=>`hsla(${200+r.dir/2},80%,70%,0.9)`),
      borderWidth:1, borderRadius:4
    }]
  },
  options:{...CHART_DEFAULTS,scales:{...CHART_DEFAULTS.scales,
    y:{...CHART_DEFAULTS.scales.y,min:0,max:360,
      ticks:{color:'#7a9ec4',callback:v=>['N','NE','E','SE','S','SO','O','NO','N'][Math.round(v/45)]+` (${v}¬∞)`}}
  }}
});

new Chart(document.getElementById('chartHocnl').getContext('2d'), {
  type:'bar', data:{
    labels:shortLabels,
    datasets:[{
      label:'HOCNL (ft)', data:rawData.map(r=>r.hocnl),
      backgroundColor:rawData.map(r=>r.hocnl<2.6?'rgba(0,229,176,0.6)':r.hocnl<6.6?'rgba(247,201,75,0.6)':r.hocnl<13.1?'rgba(240,124,58,0.6)':'rgba(232,48,48,0.6)'),
      borderRadius:4
    }]
  }, options:{...CHART_DEFAULTS}
});

new Chart(document.getElementById('chartCombined').getContext('2d'), {
  type:'line', data:{
    labels:shortLabels,
    datasets:[
      {label:'Viento (kt)', data:rawData.map(r=>r.wind), borderColor:'#00c8ff',tension:0.4,fill:false,yAxisID:'y',pointRadius:1},
      {label:'R√°faga (kt)',data:rawData.map(r=>r.gust), borderColor:'#f7c94b',tension:0.4,fill:false,borderDash:[4,2],yAxisID:'y',pointRadius:1},
      {label:'Olas (ft)',  data:rawData.map(r=>r.wave), borderColor:'#00e5b0',tension:0.4,fill:true,backgroundColor:'rgba(0,229,176,0.06)',yAxisID:'y2',pointRadius:1},
      {label:'Swell (ft)', data:rawData.map(r=>r.swell),borderColor:'#c084fc',tension:0.4,fill:false,borderDash:[3,3],yAxisID:'y2',pointRadius:1},
      {label:'HOCNL (ft)', data:rawData.map(r=>r.hocnl),borderColor:'#fb923c',tension:0.4,fill:false,yAxisID:'y2',pointRadius:1},
    ]
  },
  options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#7a9ec4',font:{size:11}}}},
    scales:{
      x:{ticks:{color:'#7a9ec4',font:{size:9}},grid:{color:'rgba(26,48,96,0.4)'}},
      y:{type:'linear',position:'left',ticks:{color:'#00c8ff',font:{size:10}},grid:{color:'rgba(26,48,96,0.3)'},title:{display:true,text:'Viento (kt)',color:'#00c8ff',font:{size:10}}},
      y2:{type:'linear',position:'right',ticks:{color:'#00e5b0',font:{size:10}},grid:{display:false},title:{display:true,text:'Altura (ft)',color:'#00e5b0',font:{size:10}}}
    }
  }
});

// ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ
const dayFilter = document.getElementById('day-filter');
for (let d = 0; d < DAYS; d++) {
  const rows = rawData.filter(r=>r.dayIndex===d);
  if (!rows.length) continue;
  const opt = document.createElement('option');
  opt.value = d;
  opt.textContent = `${rows[0].dayName} ${rows[0].dateStr}`;
  dayFilter.appendChild(opt);
}

function buildTable(data) {
  let prevDate = null;
  document.getElementById('table-body').innerHTML = data.map(r => {
    const showDate = r.dateStr !== prevDate;
    prevDate = r.dateStr;
    return `<tr>
      <td style="color:var(--text-muted);font-size:0.78rem;">${showDate?`<b>${r.dayName} ${r.dateStr}</b>`:''}</td>
      <td class="td-hora">${r.hora}</td>
      <td style="font-weight:700;color:#00c8ff">${r.wind}</td>
      <td style="color:#f7c94b">${r.gust}</td>
      <td>
        <span style="display:inline-block;transform:rotate(${r.dir}deg);font-size:18px">‚Üë</span>
        <span style="color:var(--text-muted);font-size:0.75rem;margin-left:4px">${r.cardinal} (${r.dir}¬∞)</span>
      </td>
      <td style="color:#00e5b0;font-weight:600">${r.wave}</td>
      <td style="color:#c084fc">${r.swell}</td>
      <td style="color:#fb923c">${r.hocnl}</td>
      <td><span class="td-estado ${r.status.cls}">${r.status.icon} ${r.status.label}</span></td>
    </tr>`;
  }).join('');
}

function filterTable() {
  const val = document.getElementById('day-filter').value;
  const filtered = val==='all' ? rawData : rawData.filter(r=>r.dayIndex===+val);
  buildTable(filtered);
  document.querySelectorAll('.fbar-card').forEach((c,i)=>{
    c.classList.toggle('active', val!=='all' && i===+val);
  });
}
buildTable(rawData);

function toggleDayView() {
  const sel = document.getElementById('day-filter');
  const cur = +sel.value;
  const next = (isNaN(cur)||sel.value==='all') ? 0 : (cur+1)%DAYS;
  sel.value = next;
  filterTable();
}

// ‚îÄ‚îÄ PDF EXPORT ‚îÄ‚îÄ
function openPdfModal() { document.getElementById('pdf-modal').classList.add('active'); }
function closeModal()   { document.getElementById('pdf-modal').classList.remove('active'); }

async function exportPDF() {
  closeModal();
  document.getElementById('loader').classList.add('active');
  const incHeader = document.getElementById('chk-header').checked;
  const incCharts = document.getElementById('chk-charts').checked;
  const incTable  = document.getElementById('chk-table').checked;
  try {
    const {jsPDF} = window.jspdf;
    const pdf = new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
    const W = pdf.internal.pageSize.getWidth();
    const H = pdf.internal.pageSize.getHeight();
    let yOffset=0, pageCount=0;
    function addPage() {
      if (pageCount>0) pdf.addPage();
      pageCount++;
      // Fondo blanco total (ahorro de tinta)
      pdf.setFillColor(255,255,255); pdf.rect(0,0,W,H,'F');
      // Banda de encabezado gris muy claro
      pdf.setFillColor(240,244,250); pdf.rect(0,0,W,20,'F');
      // Acento azul oscuro delgado a la izquierda
      pdf.setFillColor(10,40,100); pdf.rect(0,0,4,20,'F');
      // Texto oscuro en encabezado
      pdf.setTextColor(10,40,100); pdf.setFontSize(10); pdf.setFont('helvetica','bold');
      pdf.text('DIAVAZ',8,9);
      pdf.setTextColor(30,80,180); pdf.setFontSize(6); pdf.text('SERVICIOS ENERGETICOS',8,14);
      pdf.setTextColor(10,40,100); pdf.setFontSize(11); pdf.setFont('helvetica','bold');
      pdf.text('Reporte Meteorologico | Ebano',58,12);
      pdf.setTextColor(80,100,140); pdf.setFontSize(8);
      pdf.text(`19.146¬∞N 92.500¬∞W ¬∑ ECMWF WAM ¬∑ ${new Date().toLocaleString('es-ES')}`,W-8,12,{align:'right'});
      // L√≠nea separadora debajo del encabezado
      pdf.setDrawColor(180,200,230); pdf.setLineWidth(0.3); pdf.line(0,20,W,20);
      yOffset=26;
    }
    addPage();
    if (incHeader) {
      for (const id of ['kpi-grid','forecast-bar']) {
        const el=document.getElementById(id);
        const canvas=await html2canvas(el,{backgroundColor:'#ffffff',scale:1.5});
        const img=canvas.toDataURL('image/jpeg',0.85);
        const w=W-16; const h=w/(canvas.width/canvas.height);
        if (yOffset+h>H-10) addPage();
        pdf.addImage(img,'JPEG',8,yOffset,w,h);
        yOffset+=h+4;
      }
    }
    if (incCharts) {
      const cards=['card-wind','card-wave','card-dir','card-hocnl'];
      let col=0,rowY=yOffset,maxH=0,cardW=(W-20)/2;
      for (let i=0;i<cards.length;i++) {
        const canvas=await html2canvas(document.getElementById(cards[i]),{backgroundColor:'#ffffff',scale:1.5});
        const img=canvas.toDataURL('image/jpeg',0.82);
        const imgH=cardW/(canvas.width/canvas.height);
        if (rowY+imgH>H-10) { addPage(); rowY=yOffset; col=0; }
        pdf.addImage(img,'JPEG',8+col*(cardW+4),rowY,cardW,imgH);
        maxH=Math.max(maxH,imgH); col++;
        if (col>=2) { col=0; rowY+=maxH+4; maxH=0; }
      }
      yOffset=rowY+maxH+4;
      addPage();
      const combCanvas=await html2canvas(document.getElementById('card-combined'),{backgroundColor:'#ffffff',scale:1.5});
      const combImg=combCanvas.toDataURL('image/jpeg',0.85);
      const cW=W-16; const cH=cW/(combCanvas.width/combCanvas.height);
      pdf.addImage(combImg,'JPEG',8,yOffset,cW,Math.min(cH,H-yOffset-10));
    }
    if (incTable) {
      addPage();
      pdf.setTextColor(10,40,100); pdf.setFontSize(10); pdf.setFont('helvetica','bold');
      pdf.text('Tabla General ‚Äî Pronostico por Hora (5 dias) ¬∑ Modelo: ECMWF WAM',8,yOffset);
      yOffset+=8;
      const cols=['Fecha','Hora','Viento (kt)','Rafaga (kt)','Dir.','Olas (ft)','Swell (ft)','HOCNL (ft)','Estado'];
      const colW=[28,18,24,24,28,20,20,22,24];
      const rowH=7;
      // Encabezado de tabla: azul oscuro con texto blanco
      pdf.setFillColor(10,40,100); pdf.rect(8,yOffset,W-16,rowH,'F');
      pdf.setTextColor(255,255,255); pdf.setFontSize(7); pdf.setFont('helvetica','bold');
      let xc=9; cols.forEach((c,i)=>{ pdf.text(c,xc,yOffset+4.5); xc+=colW[i]; }); yOffset+=rowH;
      pdf.setFont('helvetica','normal'); pdf.setFontSize(7);
      rawData.forEach((r,idx) => {
        if (yOffset+rowH>H-8) { addPage(); yOffset=26; }
        // Filas alternas: gris muy claro / blanco
        if (idx%2===0) { pdf.setFillColor(245,248,252); pdf.rect(8,yOffset,W-16,rowH,'F'); }
        let xr=9;
        // Colores para impresi√≥n en claro (oscuros sobre fondo blanco)
        pdf.setTextColor(80,100,140);  pdf.text(`${r.dayName} ${r.dateStr}`,xr,yOffset+4.5); xr+=colW[0];
        pdf.setTextColor(10,80,180);   pdf.text(r.hora,xr,yOffset+4.5); xr+=colW[1];
        pdf.setTextColor(20,20,20);    pdf.text(String(r.wind),xr,yOffset+4.5); xr+=colW[2];
        pdf.setTextColor(160,100,0);   pdf.text(String(r.gust),xr,yOffset+4.5); xr+=colW[3];
        pdf.setTextColor(60,80,120);   pdf.text(`${r.cardinal} ${r.dir}¬∞`,xr,yOffset+4.5); xr+=colW[4];
        pdf.setTextColor(0,130,100);   pdf.text(String(r.wave),xr,yOffset+4.5); xr+=colW[5];
        pdf.setTextColor(100,50,160);  pdf.text(String(r.swell),xr,yOffset+4.5); xr+=colW[6];
        pdf.setTextColor(180,80,0);    pdf.text(String(r.hocnl),xr,yOffset+4.5); xr+=colW[7];
        const sc={'Bonanza':[0,130,100],'Moderado':[160,100,0],'Agitado':[180,60,0],'Severo':[180,0,0]};
        pdf.setTextColor(...(sc[r.status.label]||[80,80,80]));
        pdf.text(r.status.label,xr,yOffset+4.5);
        yOffset+=rowH;
      });
    }
    const total=pdf.internal.getNumberOfPages();
    for (let p=1;p<=total;p++) {
      pdf.setPage(p); pdf.setTextColor(100,120,160); pdf.setFontSize(7);
      pdf.text(`DIAVAZ ‚Äî Reporte Meteorologico | Ebano  ¬∑  Pagina ${p} de ${total}`,W/2,H-4,{align:'center'});
    }
    pdf.save('DIAVAZ_Reporte_Meteorologico_Ebano.pdf');
  } catch(e) { console.error(e); alert('Error PDF: '+e.message); }
  document.getElementById('loader').classList.remove('active');
}
</script>
</body>
</html>